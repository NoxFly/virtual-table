# Virtual Table Agent Guide
- **Core purpose**: exposes a DOM-only virtualized tree/table component (`VirtualTable<T>`) with reusable row elements, manual scroll handling, and hooks for selection, editing, and DnD. `src/index.ts` re-exports the public API.
- **Key data structures**: the component stores raw tree data in `this.tree`, a visible linear projection in `this.flatten`, and a fixed pool of DOM-backed rows in `this.rows`. Every `TreeNode` tracks `flatIndex`, circular siblings (`left/right`), and parent pointers for O(1) navigation.
- **Virtualization flow**: `setData` deep-clones inputs (`structuredClone`) before calling `recomputeDataTree`. Any structural change (add, delete, expand) must finish with `DOM_computeInViewVisibleRows()` to rebuild `flatten`, resize the viewport, and refresh the row pool.
- **Scroll math**: row positioning relies on `ROW_HEIGHT - 1` to account for CSS borders; the clamped `scrollTopIndex` and `maxScrollableIndex` in `DOM_updateScroll` must stay consistent with buffer sizes (`VISIBLE_ROWS_COUNT`) to avoid blank gaps.
- **Column definitions**: `ColumnsDefs` auto-injects `id` via `crypto.randomUUID()`. Widths default to pixels but switch to percentages when `columnSizeInPercentage` is true. Hidden columns are skipped at creation and removed via `DOM_removeCell`.
- **Selection & editing**: row and cell selections live in `selectedNodes`, `selectedCells`, and `selectedColumns`. Editing is gated by `allowCellEditing` and column `readonly/required` flags; commit new values through `onCellEdited` callbacks.
- **Tree mutations**: `addNodes`, `deleteNodes`, and `updateNodes` all maintain `nodeMap` for O(1) lookup. Insertions repair circular sibling links, so when extending these methods update both `left/right` and children arrays.
- **Event surface**: consumers rely on the various `on*` callback placeholders (row/cell clicks, context menus, drop). Preserve these hooks or document breaking changes.
- **EventManager**: helper for DOM listeners using `Symbol.for(callback.name)`; keep callback names stable when using `listenTo`/`stopListenTo`, or store the returned symbol.
- **Styling pipeline**: component styles live in `src/styles/VirtualTable.module.css`. `tsup` copies the module CSS and any root `*.d.ts` into `dist/` via `cp`; on Windows run builds in Git Bash/WSL or replace with a cross-platform copy step before committing.
- **Build commands**: `npm run build` (tsup → `dist/` CJS+ESM, sourcemaps, MIT banner) and `npm run dev` (parallel Vite build watch + dev server). `npm run preview` serves the library using Vite’s preview mode.
- **Linting**: `npm run lint` runs ESLint with TypeScript type-checking (`tsc --noEmit`). The config enforces 4-space indentation, Stroustrup braces, explicit member accessibility, and prefers readonly fields.
- **Test harness**: the `/test` Vite server bootstraps sample scenarios (`test/js/tests/*.js`) and toggles themes. Use it to manually verify scroll behaviour, selection, and editing without extra setup.
- **Distribution layout**: `package.json` exposes `dist/VirtualTable.js` as the main entry. Keep the directory clean of transient assets; `tsup` runs with `clean: false`, so delete stale artifacts manually when altering bundle names.
- **Type definitions**: `VirtualTableOptions` and domain types in `src/types.ts` drive both runtime behaviour and generated `d.ts`. When adding fields, update the interfaces, default options, and any cloning logic together.
- **Performance considerations**: avoid per-scroll DOM allocations—reuse existing rows via `DOM_setRowPosition` and update content with `DOM_updateRowContent`. New features must respect this pattern to maintain smooth virtual scrolling.
- **Preferred workflow**: for feature work run `npm run dev` to get automatic rebuilds and hot-reloadable demo data; for CI-congruent verification run `npm run lint` and `npm run build`.
- **Common pitfalls**: forgetting to update `nodeMap` leads to stale lookups; bypassing `structuredClone` breaks immutability expectations; modifying `ROW_HEIGHT` without syncing CSS `--row-height` causes misalignment.
- **Where to start**: explore `VirtualTable.DOM_computeInViewVisibleRows`, `DOM_updateScroll`, and `DOM_updateRowContent` to understand rendering; mirror existing private helpers (`DOM_*`) for new DOM-related behaviour.
